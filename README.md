## Iface.Oik.EventDispatcher

Программа для обработки поступающих событий сервера «ОИК Диспетчер НТ».

Программа может работать как внешняя задача Сервера «ОИК Диспетчер НТ» или автономно на любом удаленном компьютера.

При запуске автономно требуется указать следующие параметры командной строки:

    Iface.Oik.EventDispatcher сервер_динамических_данных компьютер имя_пользователя пароль
    
Например:

    Iface.Oik.EventDispatcher TMS 10.0.0.69 admin password

## Установка и обновление программы

<Написать про распаковку архива, автономно без разницы куда, как внешняя задача - в каталог сервера для свежих версий>

При первичной установке требуется скопировать всё содержимое каталога архива, затем добавить в каталог `configs` требуемые файлы конфигурации обработчиков событий (см. ниже).

При обновлении программы требуется обновить только каталог `bin`, не изменяя имеющиеся файлы конфигураций в каталоге `configs`.
    
## Как работает программа

После запуска программа с определенным периодом проверяет наличие новых событий на Сервере «ОИК Диспетчер НТ».

В случае обнаружения новых событий вызывается один или несколько обработчиков, каждый из которых выполняет заданные действия с набором поступивших событий.

## Конфигурация обработчиков событий

Конфигурация каждого экземпляра обработчика хранится в папке `samples` в отдельном файле с расширением .json, при этом общее количество файлов не ограничено (один обработчик может быть задействован в нескольких конфигурациях, например, с разным фильтром событий).

Для конфигурации файлов используется распространенный формат [JSON](https://ru.wikipedia.org/wiki/JSON).

Структура файла выглядит примерно так:
```
{
  "Filter": {
    ... 
  },
  "Worker" : "имя_обработчика",
  "Options": {
    ...
  }
}
```

#### Фильтр

Фильтр является опциональным, может не использоваться, тогда будут обработаны все поступившие события.

Если фильтр задан, можно опционально фильтровать по типам, важности и адресам событий. Пример полного задания фильтра (допускается использование любого количества параметров фильтра):
```
"Filter": {
  "Importances": [2, 3],
  "Types": ["StatusChange", "Alarm"],
  "Statuses": ["20:1:1"],
  "Analogs": ["20:1:1..99"]
}
```

Уровни важности событий перечисляются через запятую для ключа `Importances`, где:
```
0 - оперативного состояния
1 - предупредительные 2
2 - предупредительные 1
3 - аварийные
```

Типы события перечисляются через запятую для ключа `Types`, где:
```
StatusChange    - изменение сигналов
Alarm           - срабатывание и снятие уставок
Control         - команды управления
Acknowledge     - квитирование оператором
ManualStatusSet - ручная установка сигналов
ManualAnalogSet - ручная установка измерений
Extended        - сообщения
```

Адреса сигналов перечисляются через запятую для ключа `Statuses`, при этом можно указать как единичный адрес (например, `0:1:1`), так и группу адресов (например, `0:1:1..10`, в этом случае будут использованы сигналы `0:1:1`, `0:1:2`, `...`, `0:1:10`).

Адреса измерений перечисляются через запятую для ключа `Analogs`, аналогично сигналам.

#### Обработчик
На данный момент доступны следующие обработчики:
- `EmailWorker` отправляет сообщения на заданные адреса электронной почты

- `FileWorker` сохраняет записи в текстовый файл

- `HttpWorker` выполняет HTTP-запрос (GET или POST) на заданный сервер

- `TelegramWorker` с помощью бота Telegram отправляет сообщения заданным пользователям или группам. Обратите внимание, данный обработчик по умолчанию не заработает на территории РФ, т.к. сеть для работы с API Telegram заблокирована Роскомнадзором.

#### Дополнительные опции обработчика

Каждый обработчик имеет свой набор опций для работы

##### Опции EmailWorker
```
Host        - имя почтового сервера SMTP (например, "smtp.gmail.com") - обязательно
Port        - порт почтового сервера SMTP (например, 465) - обязательно
UseSsl      - использовать безопасное соединение SSL/TLS (true или false) - опционально, по умолчанию false
Login       - имя пользователя почтового сервера - опционально
Password    - пароль пользователя - опционально
From        - имя отправителя письма - обязательно
FromEmail   - адрес отправителя письма (для популярных сервисов обычно совпадает с именем пользователя) - обязательно
SendTo      - один или несколько адресов получателей писем (например, ["addr1@gmail.com", "addr2@yandex.ru"]) - обязательно
IsHtml      - является ли текст сообщения HTML или простым текстом (true или false) - опционально, по умолчанию false
Subject     - заголовок письма, разрешены специальные значения шаблонов для подстановки значений события (см. ниже) - опционально, по умолчанию "Новые события ОИК Диспетчер НТ"
Body        - текст письма, разрешены специальные значения шаблонов для подстановки значений события (см. ниже) - опционально, по умолчанию обычный текст события, описанный ниже
BatchEvents - группировать события в одном письме или нет (true или false). В случае появляения ряда событий, близких по времени, можно сгруппировать события в одном письме, в противном случае отправится много писем одновременно.
```
Пример:
```
"options": {
  "host": "smtp.mail.ru",
  "port": 465,
  "useSsl": true,
  "login": "<login>",
  "password": "<password>",
  "from": "События «ОИК Диспетчер НТ»",
  "fromEmail": "<login>",
  "sendTo": ["<email-1>", "<email-2>", "<email-3>"],
  "subject": "Событие {importance}: {name}, {state}"
}
```

Ссылки на настройки популярных почтовых сервисов:

- Gmail - https://support.google.com/mail/answer/7126229?hl=ru
- Яндекс - https://yandex.ru/support/mail/mail-clients.html
- mail.ru - https://help.mail.ru/mail/mailer/popsmtp

##### Опции FileWorker
```
FilePath  - путь к файлу для записи событий - обязательно
Body      - текст строки для записи, разрешены специальные значения шаблонов для подстановки значений события (см. ниже) - опционально, по умолчанию обычный текст события, описанный ниже
```
Пример:
```
"options": {
  "filePath": "D:/my_folder/events.txt",
  "body": "Новое событие: {time:HH:mm:ss}, {importance}"
}
```

##### Опции HttpWorker
```
Method  - тип запроса (GET или POST) - обязательно
Url     - адрес запроса (например: https://my-api.ru/event_dispatcher/) - обязательно
Body    - тело запроса, разрешены специальные значения шаблонов для подстановки значений события (см. ниже) - опционально, по умолчанию обычный текст события, описанный ниже
```
Пример:
```
"options" : {
  "method": "get",
  "url": "http://localhost:3000/?imp={importanceId}",
  "body" : "{\"event\":\"{defaultBody}\"}"
}
```

##### Опции TelegramWorker
Обратите внимание, данный обработчик по умолчанию не заработает на территории РФ, т.к. сеть для работы с API Telegram заблокирована Роскомнадзором. 
```
BotToken  - токен бота Telegram (например, 987654321:abcdefg123_hijkQWZ) - обязательно
ChatIds   - один или несколько ID пользователей или групп для отправки сообщений (например, [823999774, 152687839]) - обязательно
Body      - текст сообщения, разрешены специальные значения шаблонов для подстановки значений события (см. ниже) - опционально, по умолчанию обычный текст события, описанный ниже
```
Пример:
```
"options": {
  "botToken": "987654321:abcdefg123_hijkQWZ",
  "chatIds": [823999774, 152687839],
  "body": "Новое событие: {time:HH:mm:ss}, {importance}"
}
```

#### Шаблоны сообщений

Внутри текста сообщений допускается использовать специальные значения шаблонов для подстановки реальных значений события

```
{defaultBody}  - сообщение события по умолчанию
{importanceId} - номер важности события, где 0 - оперативного состояния; 1 - предупредительные 2; 2 - предупредительные 1; 3 - аварийные
{importance}   - краткий текст важности события, где ОС - оперативного состояния; ПС2 - предупредительные 2; ПС1 - предупредительные 1; АС - аварийные
{name}         - наименование события, например, наименование сигнала команды ТУ, наименование измерения уставки
{state}        - состояние события, например, текст переключения сигнала, взведенность/снятие для уставки
{type}         - тип события, например, команда ТУ, наименование уставки
{username}     - имя пользователя, выдавшего команду - может быть пустым
{tmAddr}       - адрес сигнала или измерения - может быть пустым
{time}         - дата и время события
```
Дополнительно есть возможность вывести конкретные фрагменты даты и времени события, например, только дату, только время, только час, только год и т.д. Для этого используется шаблон `{time:<формат_даты_и_времени>}`. Используется стандартный формат даты и времени, описанный, например, здесь - https://docs.microsoft.com/ru-ru/dotnet/standard/base-types/custom-date-and-time-format-strings

Примеры строк с шаблонами, и во что они могут трансформироваться при поступлении события:
```
Событие {importance}: {name}, {state}
Событие ПС2: ПС Варежка В-220, Включен
```

```
Внимание, обнаружено новое событие: {time:HH:mm:ss}, {importance}, {name}, {state}, {type}, {username}    Просьба принять меры!
Внимание, обнаружено новое событие: 21:35:12, ОС, ПС Лаптевая ВЛ-35 кВ Лаптевая-Былинная В-35, Команда ТУ, Выключатель, Петров В. И.    Просьба принять меры
```

#### Примеры конфигураций
Примеры конфигураций доступны в каталоге `sample_configs` в архиве установки.

## Информация для разработчиков

Исходные коды программы являются открытыми, лицензия MIT.

Если вы хотите расширить функционал программы, то можете легко самостоятельно добавить свой обработчик событий.

Клонируйте проект, добавляете свой класс обработчика, унаследовав его от базового класса `Worker`. Регистрировать новый обработчик нигде не нужно, список обработчиков находится с помощью Reflection при запуске программы.

Обязательным для реализации является метод обработки входящего (с учетом фильтра конфигурации) списка событий:

```
protected override async Task DoWork(IReadOnlyCollection<TmEvent> tmEvents)
{
  ...
}
```
    
Дополнительно можно переопределить методы конфигурации и инициализации (например, для проверки удаленного сервера):

```
public override void Configure(JObject options)
{
  ...
}

public override async Task Initialize()
{
  ...
}
```

Если ваш обработчик мог бы пригодиться другим людям, и вы готовы бы им поделиться, мы будем рады пулл-реквесту 😀